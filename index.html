<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Arum - AI Chatbot</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/all.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'dark-bg': '#111827',
            'dark-secondary': '#1f2937',
            'text-light': '#f0fdfa',
            'text-gray': '#9ca3af',
            'accent': '#2dd4bf',
            'accent-dark': '#0d9488'
          },
          fontFamily: {
            serif: ['DM Serif Display', 'serif'],
            sans: ['Plus Jakarta Sans', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --vh: 1vh;
    }
    /* Reset dasar dan styling global */
    body, html {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: #111827;
      color: #f0fdfa;
    }
    /* Scrollbar kustom untuk chat body */
    .chat-body::-webkit-scrollbar {
      width: 8px;
    }
    .chat-body::-webkit-scrollbar-thumb {
      background-color: #374151;
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-dark-bg text-text-light">
  <div class="chat-container flex flex-col h-[calc(var(--vh,1vh)*100)]">
    <!-- Header -->
    <header class="chat-header bg-dark-secondary p-5 flex items-center font-serif text-xl font-semibold">
      <span>S E R A</span>
    </header>
    <!-- Body -->
    <main id="chat-body" class="chat-body flex-1 overflow-y-auto p-5 space-y-4">
      <!-- Pesan chat akan muncul di sini -->
    </main>
    <!-- Footer / Input -->
    <form id="chat-form" class="chat-footer flex items-center bg-dark-secondary p-4 space-x-4">
      <textarea id="chat-input" class="chat-input flex-1 p-3 rounded-lg bg-dark-secondary text-text-light resize-none transition-all focus:outline-none focus:ring-2 focus:ring-accent" placeholder="Tanyakan sesuatu..." rows="1"></textarea>
      <button type="submit" class="chat-send w-14 h-14 flex items-center justify-center text-2xl rounded-full transition-transform disabled:opacity-50 disabled:cursor-not-allowed" disabled>
        <i class="fa-solid fa-arrow-up"></i>
      </button>
    </form>
  </div>

  <script>
    // Atur tinggi viewport dinamis
    function setVh() {
      document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
    }
    setVh();
    window.addEventListener('resize', setVh);

    // Seleksi elemen dengan vanilla JS
    const chatInput = document.getElementById('chat-input');
    const chatForm = document.getElementById('chat-form');
    const chatBody = document.getElementById('chat-body');
    const chatSend = document.querySelector('.chat-send');
    let isLoading = false;
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    // Aktifkan tombol kirim saat input terisi
    chatInput.addEventListener('input', () => {
      chatSend.disabled = chatInput.value.trim() === '' || isLoading;
      adjustTextArea();
    });

    // Tangani penekanan tombol Enter (desktop: Enter untuk submit, Shift+Enter untuk newline)
    chatInput.addEventListener('keydown', (e) => {
      if (!isMobile) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
        }
      }
    });

    // Proses submit chat
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = chatInput.value.trim();
      if (message === '' || isLoading) return;
      isLoading = true;
      chatSend.disabled = true;

      // Tambahkan pesan pengguna
      const userMsg = document.createElement('div');
      userMsg.className = 'chat-message user bg-white text-dark-bg self-end rounded-lg p-3';
      userMsg.innerHTML = message.replace(/\n/g, "<br>");
      chatBody.appendChild(userMsg);
      chatInput.value = '';
      adjustTextArea();
      scrollChatToBottom();

      // Tambahkan pesan placeholder bot
      const botMsg = document.createElement('div');
      botMsg.className = 'chat-message bot bg-accent text-dark-bg self-start rounded-lg p-3';
      botMsg.innerHTML = `<span class="loading inline-flex space-x-1">
        <span class="animate-bounce">.</span>
        <span class="animate-bounce delay-200">.</span>
        <span class="animate-bounce delay-400">.</span>
      </span>`;
      chatBody.appendChild(botMsg);
      scrollChatToBottom();

      try {
        const response = await fetch("https://gemininodejsaspri-production.up.railway.app/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ chat: message, history: [] }),
          credentials: "include"
        });
        const data = await response.json();
        isLoading = false;
        chatSend.disabled = chatInput.value.trim() === '';
        botMsg.innerHTML = data.response.trim().replace(/\n/g, "<br>");
        scrollChatToBottom();
      } catch (error) {
        isLoading = false;
        chatSend.disabled = chatInput.value.trim() === '';
        botMsg.innerHTML = "Maaf, terjadi kesalahan.";
        scrollChatToBottom();
      }
    });

    // Fungsi scroll dengan smooth behavior
    function scrollChatToBottom() {
      chatBody.scrollTo({
        top: chatBody.scrollHeight,
        behavior: 'smooth'
      });
    }

    // Fungsi menyesuaikan tinggi textarea sesuai isinya
    function adjustTextArea() {
      chatInput.style.height = 'auto';
      const newHeight = chatInput.scrollHeight;
      const maxHeight = 150; // batas maksimal tinggi dalam piksel
      if (newHeight > maxHeight) {
        chatInput.style.height = maxHeight + 'px';
        chatInput.style.overflowY = 'auto';
      } else {
        chatInput.style.height = newHeight + 'px';
        chatInput.style.overflowY = 'hidden';
      }
    }
  </script>
</body>
</html>
