<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Arum - AI Chatbot</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://site-assets.fontawesome.com/releases/v6.6.0/css/all.css"
    />
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              'dark-bg': '#111827',
              'dark-secondary': '#1f2937',
              'text-light': '#f0fdfa',
              'text-gray': '#9ca3af',
              'accent': '#2dd4bf',
              'accent-dark': '#0d9488'
            },
            fontFamily: {
              serif: ['DM Serif Display', 'serif'],
              sans: ['Plus Jakarta Sans', 'sans-serif']
            }
          }
        }
      }
    </script>
    <style>
      /* Atur tinggi viewport secara dinamis */
      :root {
        --vh: 1vh;
      }
      /* Custom scrollbar untuk chat-body */
      .chat-body::-webkit-scrollbar {
        width: 10px;
      }
      .chat-body::-webkit-scrollbar-thumb {
        background-color: #374151;
        border-radius: 5px;
      }
    </style>
  </head>
  <body class="bg-dark-bg text-text-light font-sans">
    <div class="chat-container flex flex-col h-screen overflow-hidden">
      <!-- Header -->
      <div class="chat-header bg-dark-secondary p-6 text-2xl font-serif text-center border-b border-gray-700">
        <span>S E R A</span>
      </div>
      <!-- Chat body -->
      <div
        class="chat-body flex-grow p-4 overflow-y-auto flex flex-col gap-4 scroll-smooth"
        id="chat-body"
      ></div>
      <!-- Chat footer -->
      <form id="chat-form" class="chat-footer bg-dark-secondary p-4 flex items-center gap-4">
        <textarea
          id="chat-input"
          class="chat-input flex-grow p-3 rounded-lg bg-dark-secondary text-text-light focus:outline-none focus:ring-2 focus:ring-accent-dark transition-all resize-none overflow-hidden max-h-40"
          placeholder="Tanyakan sesuatu..."
          autocomplete="off"
          rows="1"
        ></textarea>
        <button type="submit" class="chat-send w-12 h-12 text-xl rounded-full flex items-center justify-center hover:scale-105 transition-transform disabled:text-text-gray disabled:cursor-not-allowed" disabled>
          <i class="fa-solid fa-arrow-up"></i>
        </button>
      </form>
    </div>

    <script>
      // Jalankan skrip setelah DOM siap
      document.addEventListener("DOMContentLoaded", () => {
        // Fungsi untuk mengatur tinggi viewport (untuk mobile)
        function setVh() {
          let vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty("--vh", `${vh}px`);
        }
        setVh();
        window.addEventListener("resize", setVh);

        const chatInput = document.getElementById("chat-input");
        const chatSend = document.querySelector(".chat-send");
        const chatBody = document.getElementById("chat-body");
        const chatForm = document.getElementById("chat-form");
        let isLoading = false;
        const isMobile =
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          );

        // Fungsi untuk mengupdate status button send
        function updateSendButton() {
          chatSend.disabled = chatInput.value.trim() === "" || isLoading;
        }

        // Sesuaikan tinggi textarea secara dinamis
        function adjustTextArea() {
          chatInput.style.height = "auto";
          const newHeight = chatInput.scrollHeight;
          const maxHeight = 150; // px
          if (newHeight > maxHeight) {
            chatInput.style.height = `${maxHeight}px`;
            chatInput.style.overflowY = "auto";
          } else {
            chatInput.style.height = `${newHeight}px`;
            chatInput.style.overflowY = "hidden";
          }
        }

        chatInput.addEventListener("input", () => {
          updateSendButton();
          adjustTextArea();
        });

        // Tangani penekanan tombol Enter (tanpa shift untuk submit di desktop)
        chatInput.addEventListener("keydown", (e) => {
          if (!isMobile) {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              chatForm.dispatchEvent(new Event("submit", { cancelable: true }));
            }
          }
        });

        // Tangani pengiriman pesan
        chatForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const message = chatInput.value.trim();
          if (message === "" || isLoading) return;
          isLoading = true;
          updateSendButton();

          // Tambahkan pesan pengguna ke chat-body
          const userMsg = document.createElement("div");
          userMsg.className =
            "self-end bg-white text-dark-bg px-4 py-2 rounded-lg shadow-md";
          userMsg.innerHTML = message.replace(/\n/g, "<br>");
          chatBody.appendChild(userMsg);
          scrollChatToBottom();
          chatInput.value = "";
          adjustTextArea();

          // Tambahkan pesan bot dengan loading animation
          const botMsg = document.createElement("div");
          botMsg.className =
            "self-start bg-accent text-dark-bg px-4 py-2 rounded-lg shadow-md";
          botMsg.innerHTML = `
            <span class="loading flex gap-1">
              <span class="block animate-bounce" style="animation-delay: 0s;">.</span>
              <span class="block animate-bounce" style="animation-delay: 0.2s;">.</span>
              <span class="block animate-bounce" style="animation-delay: 0.4s;">.</span>
            </span>
          `;
          chatBody.appendChild(botMsg);
          scrollChatToBottom();

          // Kirim pesan menggunakan fetch (AJAX)
          try {
            const response = await fetch(
              "https://gemininodejsaspri-production.up.railway.app/chat",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                credentials: "include",
                body: JSON.stringify({ chat: message, history: [] })
              }
            );
            if (!response.ok) throw new Error("Network response not ok");
            const data = await response.json();
            botMsg.innerHTML = data.response.trim().replace(/\n/g, "<br>");
          } catch (error) {
            botMsg.innerHTML = "Maaf, terjadi kesalahan.";
          }
          isLoading = false;
          updateSendButton();
          scrollChatToBottom();
        });

        // Fungsi scroll untuk chat-body
        function scrollChatToBottom() {
          chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });
        }
      });
    </script>
  </body>
</html>
